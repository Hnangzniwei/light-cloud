# cant.yml  —— 一键部署「腾讯云轻量应用服务器」
name: deploy-tencent-lighthouse
vars:                      # 按需修改
  CLOUD_PROVIDER: tencent  # 或 aws
  REGION: ap-beijing
  SSH_KEY_NAME: mykey
  IMAGE_ID: img-lightsail-centos7
  PLAN_ID: bundle_small
  DOCKER_IMAGE: nginx:1.25-alpine
  LOCAL_PORT: 8080

steps:
  - name: install-terraform
    run: |
      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
      echo "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
        | sudo tee /etc/apt/sources.list.d/hashicorp.list
      sudo apt-get update && sudo apt-get install -y terraform

  - name: install-tccli
    when: ${{ vars.CLOUD_PROVIDER == 'tencent' }}
    run: |
      pip3 install tccli
      tccli configure set secretId     ${{ secrets.TENCENT_SECRET_ID }}
      tccli configure set secretKey    ${{ secrets.TENCENT_SECRET_KEY }}
      tccli configure set region       ${{ vars.REGION }}

  - name: install-aws-cli
    when: ${{ vars.CLOUD_PROVIDER == 'aws' }}
    run: |
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
      unzip -q awscliv2.zip && sudo ./aws/install
      aws configure set aws_access_key_id     ${{ secrets.AWS_ACCESS_KEY_ID }}
      aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      aws configure set default.region        ${{ vars.REGION }}

  - name: terraform-deploy
    run: |
      terraform init
      terraform apply -auto-approve \
        -var="region=${{ vars.REGION }}" \
        -var="key_name=${{ vars.SSH_KEY_NAME }}" \
        -var="image_id=${{ vars.IMAGE_ID }}" \
        -var="plan_id=${{ vars.PLAN_ID }}" \
        -var="docker_image=${{ vars.DOCKER_IMAGE }}"

  - name: wait-for-ssh
    run: |
      IP=$(terraform output -raw public_ip)
      echo "Instance IP: $IP"
      until ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@$IP 'echo SSH ready'; do
        sleep 5
      done

  - name: open-ssh-tunnel
    run: |
      IP=$(terraform output -raw public_ip)
      chmod +x access.sh
      ./access.sh $IP ${{ vars.LOCAL_PORT }}

  - name: verify
    run: |
      curl -I http://localhost:${{ vars.LOCAL_PORT }}
