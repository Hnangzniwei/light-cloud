name: Deploy to Cloud (Tencent / AWS)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      cloud_provider:
        description: 'Cloud Provider (tencent or aws)'
        required: true
        default: 'tencent'
      terraform_action:
        description: 'Terraform Action (plan or apply)'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply

jobs:
  terraform:
    name: Terraform <LaTex>${{ github.event\_name == 'workflow\_dispatch' && github.event.inputs.terraform\_action || 'apply' }}[ty-n]    runs-on: ubuntu-latest[ty-n]    environment: production[ty-n][ty-n]    steps:[ty-n]      # ğŸ”¹ æ­¥éª¤ 1: æ£€å‡ºä»£ç [ty-n]      - name: Checkout code[ty-n]        uses: actions/checkout@v4[ty-n][ty-n]      # ğŸ”¹ æ­¥éª¤ 2: è®¾ç½® Terraform[ty-n]      - name: Setup Terraform[ty-n]        uses: hashicorp/setup-terraform@v3[ty-n]        with:[ty-n]          terraform\_version: 1.6.6[ty-n]          cli\_config\_credentials\_token: $</LaTex>{{ secrets.TF_API_TOKEN }}

      # ğŸ”¹ æ­¥éª¤ 3: æ£€æŸ¥å¯†ç æ˜¯å¦æ³¨å…¥ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯é€‰ï¼‰
      - name: Check password injected
        run: echo "Password length: <LaTex>${#TF\_VAR\_instance\_password}"[ty-n]        env:[ty-n]          TF\_VAR\_instance\_password: $</LaTex>{{ secrets.INSTANCE_PASSWORD }}

      # ğŸ”¹ æ­¥éª¤ 4: Terraform Init
      - name: Terraform Init
        run: terraform init
        env:
          TF_VAR_TENCENT_SECRET_ID: <LaTex>${{ secrets.TENCENT\_SECRET\_ID }}[ty-n]          TF\_VAR\_TENCENT\_SECRET\_KEY: $</LaTex>{{ secrets.TENCENT_SECRET_KEY }}
          # AWS ä½¿ç”¨é»˜è®¤å‡­è¯é“¾ï¼Œæ— éœ€æ˜¾å¼ä¼ å…¥

      # ğŸ”¹ æ­¥éª¤ 5: Terraform Plan
      - name: Terraform Plan
        run: |
          terraform plan \
            -var="cloud_provider=<LaTex>${{ github.event\_name == 'workflow\_dispatch' && github.event.inputs.cloud\_provider || 'tencent' }}" \[ty-n]            -var="instance\_password=$</LaTex>{{ secrets.INSTANCE_PASSWORD }}" \
            -var="aws_key_name=<LaTex>${{ secrets.AWS\_KEY\_NAME || 'mykey' }}" \[ty-n]            -no-color[ty-n]        env:[ty-n]          TF\_VAR\_TENCENT\_SECRET\_ID: $</LaTex>{{ secrets.TENCENT_SECRET_ID }}
          TF_VAR_TENCENT_SECRET_KEY: <LaTex>${{ secrets.TENCENT\_SECRET\_KEY }}[ty-n][ty-n]      # ğŸ”¹ æ­¥éª¤ 6: Terraform Applyï¼ˆä»…å½“æ‰‹åŠ¨è§¦å‘ä¸”é€‰æ‹© apply æ—¶æ‰§è¡Œï¼‰[ty-n]      - name: Terraform Apply[ty-n]        if: github.event\_name == 'workflow\_dispatch' && github.event.inputs.terraform\_action == 'apply'[ty-n]        run: |[ty-n]          terraform apply \[ty-n]            -var="cloud\_provider=$</LaTex>{{ github.event.inputs.cloud_provider }}" \
            -var="instance_password=<LaTex>${{ secrets.INSTANCE\_PASSWORD }}" \[ty-n]            -var="aws\_key\_name=$</LaTex>{{ secrets.AWS_KEY_NAME || 'mykey' }}" \
            -auto-approve
        env:
          TF_VAR_TENCENT_SECRET_ID: <LaTex>${{ secrets.TENCENT\_SECRET\_ID }}[ty-n]          TF\_VAR\_TENCENT\_SECRET\_KEY: $</LaTex>{{ secrets.TENCENT_SECRET_KEY }}

      # ğŸ”¹ æ­¥éª¤ 7: è¾“å‡ºç»“æœ
      - name: Output Public IP
        if: success()
        run: |
          echo "âœ… Deployment succeeded!"
          echo "Public IP: <LaTex>${{ steps.terraform-output.outputs.public\_ip }}"[ty-n]          echo "SSH Command: $</LaTex>{{ steps.terraform-output.outputs.ssh_command }}"
