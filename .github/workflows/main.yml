name: Deploy Lighthouse Instance with Terraform

on:
  push:
    branches:
      - main  # 根据需要调整触发分支

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0  # 根据需要调整 Terraform 版本

      steps:
  - name: Checkout code
    uses: actions/checkout@v3

  - name: Set up Terraform
    uses: hashicorp/setup-terraform@v2
    with:
      terraform_version: "1.3.0"

  - name: Check if TF_VAR_instance_password is injected
    run: |
      if [ -z "$TF_VAR_instance_password" ]; then
        echo "❌ TF_VAR_instance_password is EMPTY!"
        echo "→ 请确认 GitHub Secret 'TF_VAR_INSTANCE_PASSWORD' 已创建且非空"
        exit 1
      else
        echo "✅ TF_VAR_instance_password is SET"
        echo "  长度：${#TF_VAR_instance_password} 位"
        echo "  首字符：${TF_VAR_instance_password:0:1}"
        echo "  末字符：${TF_VAR_instance_password: -1}"
        echo "（完整值已打码，仅用于验证）"
      fi
    env:
      TF_VAR_instance_password: ${{ secrets.TF_VAR_INSTANCE_PASSWORD }}

  - name: Terraform Init
    run: terraform init

  - name: Terraform Plan
    run: terraform plan
    env:
      TF_VAR_instance_password: ${{ secrets.TF_VAR_INSTANCE_PASSWORD }}


- name: Terraform Init
  run: terraform init

- name: Terraform Plan
  run: terraform plan
  env:
    TF_VAR_instance_password: ${{ secrets.TF_VAR_INSTANCE_PASSWORD }}



      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: terraform plan
        env:
          TF_VAR_TENCENT_SECRET_ID: ${{ secrets.TF_VAR_TENCENT_SECRET_ID }}
          TF_VAR_TENCENT_SECRET_KEY: ${{ secrets.TF_VAR_TENCENT_SECRET_KEY }}
          TF_VAR_LIGHTHOUSE_KEY_ID: ${{ secrets.TF_VAR_LIGHTHOUSE_KEY_ID }}
          TF_VAR_INSTANCE_PASSWORD: ${{ secrets.TF_VAR_INSTANCE_PASSWORD }}  # 确保大小写一

      - name: Terraform Apply
        run: terraform apply -auto-approve
        env:
          TF_VAR_TENCENT_SECRET_ID: ${{ secrets.TF_VAR_TENCENT_SECRET_ID }}
          TF_VAR_TENCENT_SECRET_KEY: ${{ secrets.TF_VAR_TENCENT_SECRET_KEY }}
          TF_VAR_LIGHTHOUSE_KEY_ID: ${{ secrets.TF_VAR_LIGHTHOUSE_KEY_ID }}
          TF_VAR_INSTANCE_PASSWORD: ${{ secrets.TF_VAR_INSTANCE_PASSWORD }}  # 确保大小写
